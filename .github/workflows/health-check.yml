name: Production Health Check

# Monitor production deployments
on:
  schedule:
    # Check every 30 minutes
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  health-check:
    name: Check Production Health
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        environment:
          - name: "Render"
            url: "https://ledgerlink.onrender.com"
          - name: "Railway"
            url: "https://ledgerlink-backend-production.up.railway.app"
    
    steps:
    - name: 🏥 Health Check - ${{ matrix.environment.name }}
      run: |
        echo "Checking ${{ matrix.environment.name }} health..."
        
        # Basic health check
        response=$(curl -s -o /dev/null -w "%{http_code}" ${{ matrix.environment.url }}/api/health)
        
        if [ $response -eq 200 ]; then
          echo "✅ ${{ matrix.environment.name }} is healthy"
        else
          echo "❌ ${{ matrix.environment.name }} health check failed (HTTP $response)"
          
          # Try detailed health check
          curl -v ${{ matrix.environment.url }}/api/health/detailed || true
          
          # Notify if this is a scheduled run
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "🚨 Scheduled health check failed for ${{ matrix.environment.name }}"
            # Add notification logic here (Slack, Discord, email, etc.)
          fi
          
          exit 1
        fi
        
    - name: 📊 Performance Check - ${{ matrix.environment.name }}
      run: |
        echo "Measuring ${{ matrix.environment.name }} performance..."
        
        start_time=$(date +%s%N)
        curl -s ${{ matrix.environment.url }}/api/health > /dev/null
        end_time=$(date +%s%N)
        
        duration_ms=$(( (end_time - start_time) / 1000000 ))
        echo "⏱️ Response time: ${duration_ms}ms"
        
        if [ $duration_ms -gt 5000 ]; then
          echo "⚠️ Slow response time detected"
        fi
        
    - name: 🔍 API Endpoint Check - ${{ matrix.environment.name }}
      run: |
        echo "Testing key endpoints for ${{ matrix.environment.name }}..."
        
        endpoints=(
          "/api/health"
          "/api/docs" 
          "/api/v1/integrations/supported-systems"
        )
        
        for endpoint in "${endpoints[@]}"; do
          echo "Testing $endpoint..."
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ matrix.environment.url }}$endpoint)
          
          if [ $response -eq 200 ]; then
            echo "✅ $endpoint is working"
          else
            echo "❌ $endpoint failed (HTTP $response)"
          fi
        done
        
  create-status-badge:
    name: Update Status Badge
    runs-on: ubuntu-latest
    needs: health-check
    if: always()
    
    steps:
    - name: 📊 Create Status Summary
      run: |
        if [ "${{ needs.health-check.result }}" = "success" ]; then
          echo "🟢 All systems operational" >> $GITHUB_STEP_SUMMARY
          echo "status=operational" >> $GITHUB_ENV
        else
          echo "🔴 Some systems experiencing issues" >> $GITHUB_STEP_SUMMARY  
          echo "status=degraded" >> $GITHUB_ENV
        fi
        
        echo "## System Status" >> $GITHUB_STEP_SUMMARY
        echo "- **Render**: $([ "${{ needs.health-check.result }}" = "success" ] && echo "✅ Operational" || echo "❌ Issues detected")" >> $GITHUB_STEP_SUMMARY
        echo "- **Railway**: $([ "${{ needs.health-check.result }}" = "success" ] && echo "✅ Operational" || echo "❌ Issues detected")" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Last checked**: $(date -u)" >> $GITHUB_STEP_SUMMARY